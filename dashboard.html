<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard | To-Do List</title>
  <link href="dashboard_style.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .editable {
      cursor: pointer;
      transition: all 0.2s;
      padding: 8px;
      border-radius: 4px;
    }
    .editable:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    .edit-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    .edit-buttons {
      margin-top: 5px;
      display: flex;
      gap: 5px;
    }
    .task-content {
      flex-grow: 1;
    }
    .completed {
      opacity: 0.7;
      text-decoration: line-through;
    }
    .task-item {
      transition: all 0.3s ease;
    }
    @keyframes taskComplete {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .task-complete-animation {
      animation: taskComplete 0.5s ease;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-info px-4">
    <a class="navbar-brand text-white fw-bold" href="index.html">To-Do List</a>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link text-white" href="categories.html">Categories</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="profile.html">Profile</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="contact.html">Contact</a></li>
      </ul>
    </div>
  </nav>

  <main class="container my-4">
    <h2 class="mb-4">Панель задач</h2>
    
    <div class="mb-4 d-flex flex-wrap gap-2">
      <button class="btn btn-outline-secondary btn-sm filter-btn" data-filter="all">Все</button>
      <button class="btn btn-outline-success btn-sm filter-btn" data-filter="done">Выполненные</button>
      <button class="btn btn-outline-warning btn-sm filter-btn" data-filter="inprogress">Невыполненные</button>
    </div>

    <div class="dashboard">
      <section>
        <h4 class="mb-3">Ваши задачи <span class="badge bg-primary" id="task-count">0</span></h4>
        <ul class="list-group" id="task-list"></ul>
      </section>

      <section>
        <h4 class="mb-3">Добавить новую задачу</h4>
        <form id="task-form">
          <div class="mb-2">
            <input type="text" class="form-control" placeholder="Введите задачу" id="task-input" required>
          </div>
          <div class="mb-2">
            <select class="form-select" id="category-select" required>
              <option value="" selected disabled>Выберите категорию</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary w-100">Добавить</button>
        </form>
      </section>
    </div>
  </main>
 
  <audio id="complete-sound" src="sounds/complete.mp3" preload="auto"></audio>
  <audio id="add-sound" src="sounds/add.mp3" preload="auto"></audio>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  $(document).ready(function() {
    const taskList = $("#task-list");
    const taskCount = $("#task-count");
    const categorySelect = $("#category-select");
    const taskForm = $("#task-form");
    const completeSound = document.getElementById('complete-sound');
    const addSound = document.getElementById('add-sound');

    loadCategories();
    loadTasks();
    updateTaskCount();

    function loadCategories() {
      const categories = JSON.parse(localStorage.getItem('categories')) || [];
      categorySelect.empty().append('<option value="" selected disabled>Выберите категорию</option>');
      categories.forEach(cat => {
        categorySelect.append($('<option>', { value: cat, text: cat }));
      });
    }

    function loadTasks() {
      const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
      taskList.empty();
      tasks.forEach(task => {
        const li = createTaskElement(task.title, task.category, task.status);
        taskList.append(li);
      });
      applyFilter('all');
    }

    function saveTasks() {
      const tasks = [];
      $("#task-list li").each(function() {
        tasks.push({
          title: $(this).find(".task-text").text(),
          category: $(this).find(".badge").text(),
          status: $(this).find(".toggle-status").attr("data-status")
        });
      });
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }

    function updateTaskCount() {
      const total = taskList.children().length;
      const completed = $(".toggle-status[data-status='done']").length;
      taskCount.text(`${completed}/${total}`);
    }

    function createTaskElement(title, category, status = 'inprogress') {
      const li = $('<li>', {
        class: 'list-group-item d-flex justify-content-between align-items-start task-item',
        css: { display: 'flex' }
      });

      const taskContent = $('<div>', {
        class: 'task-content editable',
        html: `
          <span class="task-text">${title}</span>
          <br>
          <span class="badge bg-secondary">${category}</span>
        `
      });
  
      const controls = $('<div>', { class: 'task-controls' });
      
      const toggleBtn = $('<button>', {
        class: `btn btn-sm toggle-status ${status === 'done' ? 'btn-success' : 'btn-outline-secondary'}`,
        'data-status': status,
        text: status === 'done' ? '✔' : 'В процессе'
      });
      
      const deleteBtn = $('<button>', {
        class: 'btn btn-sm btn-danger btn-delete',
        html: '&times;'
      });
      
      controls.append(toggleBtn, ' ', deleteBtn);
      li.append(taskContent, controls);

      setupTaskEditing(li);
      addEventListeners(li);
      
      return li;
    }

    function setupTaskEditing(taskElement) {
      const contentDiv = $(taskElement).find('.task-content');
      const textSpan = $(taskElement).find('.task-text');
      const badge = $(taskElement).find('.badge').clone();
      
      contentDiv.on('dblclick', function() {
        const currentText = textSpan.text();
        const input = $('<input>', {
          type: 'text',
          class: 'form-control edit-input',
          value: currentText
        });
        
        const buttonDiv = $('<div>', { class: 'edit-buttons' });
        const saveBtn = $('<button>', {
          class: 'btn btn-sm btn-success',
          text: 'Save'
        });
        const cancelBtn = $('<button>', {
          class: 'btn btn-sm btn-outline-secondary',
          text: 'Cancel'
        });
        
        buttonDiv.append(saveBtn, cancelBtn);
        contentDiv.html(input);
        contentDiv.append($('<br>'));
        contentDiv.append(badge.clone());
        contentDiv.append(buttonDiv);
        
        input.focus();
        
        const saveHandler = function() {
          const newText = input.val().trim();
          if (newText && newText !== currentText) {
            textSpan.text(newText);
            contentDiv.html(textSpan).append($('<br>')).append(badge);
            saveTasks();
          } else {
            cancelHandler();
          }
        };
        

        const cancelHandler = function() {
          contentDiv.html(textSpan).append($('<br>')).append(badge);
        };
        
        saveBtn.on('click', saveHandler);
        cancelBtn.on('click', cancelHandler);
        input.on('keypress', function(e) {
          if (e.which === 13) saveHandler();
        });
        input.on('keydown', function(e) {
          if (e.key === 'Escape') cancelHandler();
        });
      });
    }

    function addEventListeners(li) {
      const toggleBtn = li.find('.toggle-status');
      const deleteBtn = li.find('.btn-delete');

      toggleBtn.on('click', function() {
        const $this = $(this);
        if ($this.attr('data-status') === 'inprogress') {
          try {
            completeSound.currentTime = 0;
            completeSound.play();
            li.addClass('task-complete-animation');
            setTimeout(() => li.removeClass('task-complete-animation'), 500);
          } catch (e) {
            console.log("Ошибка звука:", e);
          }
        }
        
        if ($this.hasClass('btn-success')) {
          $this.removeClass('btn-success').addClass('btn-outline-secondary')
            .text('В процессе').attr('data-status', 'inprogress');
          li.removeClass('completed');
        } else {
          $this.removeClass('btn-outline-secondary').addClass('btn-success')
            .text('✔').attr('data-status', 'done');
          li.addClass('completed');
        }
        saveTasks();
        updateTaskCount();
      });

      deleteBtn.on('click', function() {
        li.fadeOut(300, function() {
          li.remove();
          saveTasks();
          updateTaskCount();
        });
      });
    }

    taskForm.on('submit', function(e) {
      e.preventDefault();
      const title = $("#task-input").val().trim();
      const category = categorySelect.val();
      
      if (title && category) {
        try {
          addSound.currentTime = 0;
          addSound.play();
        } catch (e) {
          console.log("Ошибка звука:", e);
        }
        
        const li = createTaskElement(title, category);
        li.hide().appendTo(taskList).fadeIn(300);
        taskForm.trigger('reset');
        saveTasks();
        updateTaskCount();
      }
    });

    $(".filter-btn").on('click', function() {
      applyFilter($(this).data('filter'));
    });

    function applyFilter(filter) {
      $("#task-list li").each(function() {
        const status = $(this).find(".toggle-status").attr("data-status");
        $(this).toggle(filter === 'all' || status === filter);
      });
    }
  });
  </script>
</body>
</html>